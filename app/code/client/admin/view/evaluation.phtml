<?php $this->getChildBlock("page/preloader"); ?>
<?php
$session = Core::getSingleton("system/session");
$accountDb = Core::getModel("account/account");
$accountType = $accountDb->getAccountType($session->get("auth")->id);

if( $accountDb->isAccountType("Admin") ) {
	$this->getChildBlock("admin/nav");
}

if( $accountDb->isAccountType("Dean") ) {
	$this->getChildBlock("admin/navdean");
}

if( $accountDb->isAccountType("Teacher") ) {
	$this->getChildBlock("admin/navteacher");
}


?>
<?php $this->getChildBlock("page/icon"); ?>
<!-- Main START -->
<main>
<?php #$this->getChildBlock("admin/profilemenu"); ?>
<div class="container">
	<h1 class="thin"><?=$this->getPageTitle()?></h1>
	<div id="dashboard">
		<?php $this->getChildBlock("page/alert"); ?>
		<div class="row"> 
			<!-- Latest Tasks START -->
			<div class="col s12 m12">
				<div class="card hoverable">
					<ul class="collection with-header">
						<div class="collection-header primary-color" style="background-color: #546e7a !important;">
							<h5 class="light" style="color: white;">
								New Evaluation
								<a href="#!" class="secondary-content tooltipped" data-position="bottom" data-delay="50" data-tooltip="View All">
									<i class="material-icons secondary-color-text">arrow_forward</i>
								</a>
							</h5>
						</div>
						<div id="tasks">
						 	<div class="row">
							    <div class="input-field col s4 offset-s4">
							      <input  id="evalcode" type="text" class="validate" name="evalCode">
							      <label class="active" for="evalcode">Code</label>

							    </div>

							    <div class="input-field col s4 offset-s4 center">
							   		<div class="row">
							   			<button class="waves-effect waves-light btn" href="#" id="genCode">Generate</button>
							   		</div>
							    	<div class="row">
							    		<a class="waves-effect waves-light btn modal-trigger" href="#modal1" id="btnEvalSubmit">Submit</a>
							    	</div>
							    </div>
							  </div>
						</div>
					</ul>
				</div>
			</div>
		</div>
		<div class="row">
			<form name="frmView">
				<div class="col s12">
					<div class="input-field col s3">
						<select name="scyear">
							<option value="" disabled>Choose your option</option>
							
							<?php
								foreach( Core::getSingleton("evaluation/evaluation")->getSchoolYear() as $scyear ) {
									?>
									<option value="<?=$scyear?>"><?=$scyear?></option>
									<?php
								}
							?>
						</select>
						<label>School Year</label>
					</div>
					<div class="input-field col s3">
						<select name="sem">
							<option value="" disabled>Choose your option</option>
							
							<?php
								foreach( Core::getSingleton("evaluation/evaluation")->getSemester() as $sem ) {
									?>
									<option value="<?=$sem?>"><?=$sem?></option>
									<?php
								}
							?>
						</select>
						<label>Semester</label>
					</div>
					<div class="input-field col s3">
						<input type="submit" value="View" class="btn">
					</div>
				</div>
			</form>
		</div>
		<div class="row"> 
			<!-- Latest Tasks START -->
			<div class="col s12 m12">
				<div class="card hoverable">
					<ul class="collection with-header">
						<div class="collection-header primary-color" style="background-color: #546e7a !important;">
							<h5 class="light" style="color: white;">
								List
								<?php
									if( Core::getModel("account/account")->isAccountType("Admin") ) {
										?>
										<a href="#!" class="secondary-content tooltipped" data-position="bottom" data-delay="50" data-tooltip="Print" onclick="printData()">
											<i class="material-icons">local_printshop</i>
										</a>
										<?php
									}
								?>
								
							</h5>
						</div>
						<div id="tasks">
							<div class="row">
								<div class="col s12">
									<?php $this->getChildBlock("admin/evaluationlist"); ?>
								</div>
							</div>
						</div>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>
</main>
<!-- Main END --> 

<!-- Modal Structure -->
	<div id="modal1" class="modal">
	<form name="frmSelectFaculty" method="POST" action="<?=Core::getBaseUrl()?>admin/evaluation/create">
		<input type="hidden" name="evalcodemodal" id="evalcodemodal" value="">
		<div class="modal-content">
			<h4 class="thin" style="color: #87a1ad;">Select Faculty Member</h4>
			<div class="row">
				
				<?php
					foreach( Core::getModel("account/account")->where("account_type_id", 3)->get() as $faculty ) {

						if( Core::getModel("account/account")->isAdmin() ) {
							?>
							<div class="col s4">
								<p>
									<input name="faculty" type="radio" value="<?=$faculty->id?>" id="<?=$faculty->id?>" />
									<label for="<?=$faculty->id?>"><?=$faculty->fname?> <?=$faculty->lname?></label>
								</p>
							</div>
							<?php
							continue;
						}


						if( Core::getModel("account/account")->sameDepartment($faculty->id) ) {
							if( Core::getModel("account/account")->hasEvaluation($faculty->id) ) {
								continue;
							}
							?>
						<div class="col s4">
							<p>
								<input name="faculty" type="radio" value="<?=$faculty->id?>" id="<?=$faculty->id?>" />
								<label for="<?=$faculty->id?>"><?=$faculty->fname?> <?=$faculty->lname?></label>
							</p>
						</div>
						<?php

						}
						
					}
				?>
				
			</div>
		</div>
	<div class="modal-footer">
		<!-- <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Agree</a> -->
		<input type="submit" name="btnEval" value="Evaluate" class="modal-action modal-close waves-effect waves-green btn-flat">
	</div>
	</form>
	</div>
<?php
	$rating = Core::getModel("evaluation/rating")->get(["id", "ave_total"]);
?>
<div id="printTable" style="display: none">
	<h1 style="text-align: center;">Evaluation Result</h1>
	<table border="0" cellpadding="12" style="width: 100%;">
			<tbody style="text-align: center;">
				<tr>
					<th>First Name</th>
					<th>Last Name</th>
					<th>Semester</th>
					<th>School Year</th>
					<th>Average</th>
				</tr>

				<?php


					$evaluationdb = Core::getModel("evaluation/evaluation");
					foreach( $evaluationdb->get() as $eval ) {
						if(! $evaluationdb->hasRatings( $eval->id ) ) {
							continue;
						} 
						$ratings[] = [ "id" => $eval->id, "ave" => $evaluationdb->getAverage( $eval->id ) ];
					}
					usort($ratings, function($a, $b) {
					    return $a['ave'] <=> $b['ave'];
					});
					$ratings = array_reverse($ratings);

				?>
				
				<?php
					$accountDataDb = Core::getModel("account/accountdata");
					$request = Core::getSingleton("url/request")->getRequest();

					foreach( $ratings as $rating ) {
						$account 		= $evaluationdb->getAccount( $rating["id"] );
						$accountData 	= $accountDataDb->where( "account_id", $account->id )->first();
						$acctSem 		= $accountData->sem;
						$acctScYear 	= $accountData->scyear;
						if( isset($request["scyear"]) or isset($request["sem"]) ) {
							$rs = $accountDataDb
								->where("account_id", $account->id)
								->where("scyear", $request["scyear"])
								->where("sem", $request["sem"])
								->first();
							if(! $rs ) {
								continue;
							}
							$acctSem = $rs->sem;
							$acctScYear = $rs->scyear;
						}
						?>
						<tr>
							<td><?=$account->fname?></td>
							<td><?=$account->lname?></td>	
							<td><?=$acctSem?></td>	
							<td><?=$acctScYear?></td>	
							<td><?=$rating["ave"]?></td>
						</tr>
						<?php
					}
				?>

			</tbody>
		</table>
</div>

<?php $this->getChildBlock("page/footer"); ?>

<script type="text/javascript">
function printData()
{
	$("#printTable").css("display", "block");
   var divToPrint=document.getElementById("printTable");
   newWin= window.open("");
   newWin.document.write(divToPrint.outerHTML);
   newWin.print();
   newWin.close();
   $("#printTable").css("display", "none");
}

	$('#btnEvalSubmit').on("click",function(){
		var code = $('#evalcode').val();
		$('#evalcodemodal').val(code);
	})

	$("#genCode").click(function(){
	    $.getJSON("<?=Core::getBaseUrl()?>admin/evaluation/getcodeapi", function(result){
	        // $.each(result, function(i, field){
	        //     $("div").append(field + " ");
	        // });

	        $('#evalcode').val("");
	        $('#evalcode').focus();
	        $('#evalcode').val(result.code);
	    });
	});
</script>